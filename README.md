# Building Cool Searching UIs with Algolia and InstantSearch

# What are we going to do?

We're gonna create a search app using Algolia, and their amazing library, InstantSearch. Our tech stack will be NextJS, as it will help us to upload the data we need to Algolia, creating the UI alongside TailwindCSS.

You ready? I'm not.

Let's go!

# Setting Up Algolia

## 1. Sign up!

Sign up to Algolia. Not gonna explain that part. It's easy! You can do it just by clicking on the Sign Up button in their page, and using your Google Account.

## 2. Basic Setup

![alt text](blog/images/image.png)

Wait until your dashboard loads.

![alt text](blog/images/image-2.png)

Here, we'll be able to create our index, which stores our data. I'll create mine with the name `hero-villains-and-co`, as you can see it in the picture. Hit on `Create Index`, and wait until `Import your records` is available.

We can do this step in many, many ways. Algolia offers us plenty of connectors and libraries, but we're gonna focus on an specific use case to take advantage of NextJS as a fullstack framework.

![alt text](blog/images/image-1.png)

Click on `Upload records`, and select `Add connector`. You'll be redirected to the `Connectors` tab of `Data Sources`.

![alt text](blog/images/image-3.png)

In my experience, many times records are stored into a single `.csv` file, so we're going to do it that way. Select `CSV` option, and press `Connect`. It will display a new screen, where you need to click on `Get Started` to start configuring.

### 2.1 Data Source Configuration

Before even thinking on how our data is going to look like (because I haven't thought of it yet), we'll start developing our endpoint.

In this new screen, you'll see different fields that we need to set up.

![alt text](blog/images/image-4.png)

First one is asking if our data is protected. We want to consider this as somewhat sensitive data we don't want people downloading freely. To protect it, we'll be using Algolia's suggestion (basic auth) to authenticate and authorize access to our `.csv`.

#### 2.1.1 `.csv` API route.

This is a great moment to do some hands on. I'll assume you don't have NextJS background, but that won't save you from reading the docs at least a little bit if any doubts come up to you or I miss a step. Hopefully, you already have it installed, otherwise, go check the official [Get Started Installation Guide](https://nextjs.org/docs/getting-started/installation).

Open up your terminal, and go to the folder where you want your project to live in. Execute the following:

```
npx create-next-app@latest algolia-instantsearch --typescript --tailwind --eslint --app --no-src-dir --import-alias="@/*"
```

As you see, there are many options. Normally, you'd set them up manually while Vercel's scaffolding tool run, but you can also skip those steps using the command above.

Once the installation is finished, we can finally code a little bit.

Let's first serve the `.csv` file.

Inside your `app` directory, create the following file: `api/csv/route.ts`.

> ⚠️ **For development purposes ONLY**, create a `data.csv` file right next to the route. This will generally be inside a secure path, generated by some other piece of software. **Don't recreate this** in a real production environment.

Feel free to populate correctly `data.csv`, or just leave some headers there to see if they are actually being downloaded.

You might also copy the file from this repository. You should already know where is located.

Going back to the API endpoint, you'll need to read the file. NextJS has its own preferred way of doing it, which you can find [here](https://vercel.com/guides/loading-static-file-nextjs-api-route).

Copy and paste the following code.

```
import { NextResponse } from "next/server";
import { promises as fs } from "fs";

export async function GET() {
  const file = await fs.readFile(
    process.cwd() + "/app/api/csv/data.csv",
    "utf8"
  );

  return new NextResponse(file, {
    headers: {
      "content-type": "text/csv",
    },
  });
}
```

This will only get the file, and then return it.

What if we test it?

Run `npm run dev` in your terminal, go to your browser and get into `http://localhost:3000/api/csv`, and check how the file is downloaded!

Exciting, isn't it? Should be ready, but we still need to add some sort of auth mechanism. Specifically for this, we'll catch only on this route.

> ⚠️ Again, **for development purposes only**, and not over-extend this post, we'll use hardcoded values. User and password should be generated for each user/entity (in this case, Algolia), using secure mechanisms of storing and data extraction.

The resulting code can look like this. Feel free to do all the modifications you want to make it prettier!

```
import { NextRequest, NextResponse } from "next/server";
import { promises as fs } from "fs";

export async function GET(req: NextRequest) {
  const authHeader = req.headers.get("authorization");

  if (!authHeader) {
    return NextResponse.json(
      { message: "Unauthorized" },
      {
        status: 401,
      }
    );
  }

  const auth = authHeader.split(" ")[1];
  const [user, pwd] = Buffer.from(auth, "base64").toString().split(":");

  if (user !== "4dmin" && pwd !== "testpwd123") {
    return NextResponse.json(
      { message: "Unauthorized" },
      {
        status: 401,
      }
    );
  }

  const file = await fs.readFile(
    process.cwd() + "/app/api/csv/data.csv",
    "utf8"
  );

  return new NextResponse(file, {
    headers: {
      "content-type": "text/csv",
    },
  });
}
```

Now, if you try to access from your browser, you shouldn't be able to do anything. You can use a tool like [Insomnia](https://insomnia.rest/download) to make a new request adding easily your authorization header, like this:

![alt text](blog/images/image-5.png)

For those "credentials", the encoded Base64 string you need is this one `NGRtaW46dGVzdHB3ZDEyMw==`. Remember that, if you want to change the password or username by some reason, you'll need to encode it again, which you can do with [btoa](https://developer.mozilla.org/en-US/docs/Web/API/btoa) using Javascript.

Everything should be ready, right?

Unfortunately, Algolia won't allow us to use localhost to upload our data. That would be a problem if we didn't have Vercel, which offers a suitable free tier that will host our application.

#### 2.1.2 Host app in Vercel

There are some steps that I'm gonna assume you know how to do: pushing your project in [GitHub](https://github.com/), and signing up/log in to [Vercel](https://vercel.com/) using your GitHub account to make the whole process easier.

Once you are in your Vercel dashboard, click on `Add New...`, and select `Project`.

![alt text](blog/images/image-6.png)

A new screen will appear where you can select your repo. Click on `Import` right next to its name:

![alt text](blog/images/image-7.png)

Next screen, leave it as it is, and just click on `Deploy`.

![alt text](blog/images/image-8.png)

Wait until your project is fully deployed. A screen like this should appear:

![alt text](blog/images/image-9.png)

# References

Some code here is based on some of the following links.

- [How to stream files from Next.js Route Handlers by Eric Burel](https://www.ericburel.tech/blog/nextjs-stream-files)

- [How do I add Basic Authentication to Nextjs node server?](https://stackoverflow.com/questions/64316886/how-do-i-add-basic-authentication-to-nextjs-node-server)
